<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Invisible Path</title>
    <style>
        body {
            margin: 0;
            background: #111;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        canvas {
            background: #000;
            display: block;
            margin: 20px auto;
            border: 2px solid white;
        }

        #records {
            margin: 20px auto;
            max-width: 400px;
        }

        #records h2 {
            color: #00ff00;
        }

        #recordsList {
            background: #222;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: #333;
            border-radius: 5px;
            border-left: 3px solid #00ff00;
        }

        .record-rank {
            font-weight: bold;
            color: #00ff00;
            margin-right: 10px;
        }

        .record-level {
            color: #ffd700;
            font-weight: bold;
        }

        .record-time {
            color: #4CAF50;
        }

        .no-records {
            color: #888;
            font-style: italic;
            padding: 20px;
        }

        button {
            padding: 8px 15px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>🧠 Invisible Path</h1>
    <p>
        Nivel: <span id="level">1</span> |
        Tiempo: <span id="time">0</span> s
    </p>
    <canvas id="game" width="360" height="360"></canvas>
    <button onclick="startGame()">Empezar</button>

    <div id="records">
        <h2>🏆 Récords</h2>
        <div id="recordsList"></div>
        <button onclick="clearRecords()" style="background: #d32f2f; color: white;">Borrar Récords</button>
    </div>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");

        const GRID = 40;
        const COLS = 9;
        const ROWS = 9;

        let running = false;
        let time = 0;
        let showPath = true;
        let level = 1;

        const player = {
            x: 4,
            y: 8,
            size: 16
        };

        let path = [];
        let goal = { x: 4, y: 0 };

        /* ===== RÉCORDS ===== */
        function loadRecords() {
            const records = localStorage.getItem('invisiblePathRecords');
            return records ? JSON.parse(records) : [];
        }

        function saveRecord(level, time) {
            const records = loadRecords();
            records.push({
                level: level,
                time: time,
                date: new Date().toLocaleDateString()
            });
            // Ordenar: primero por nivel (mayor a menor), luego por tiempo (menor a mayor)
            records.sort((a, b) => {
                if (b.level !== a.level) {
                    return b.level - a.level; // Mayor nivel primero
                }
                return a.time - b.time; // Si empatan en nivel, menor tiempo primero
            });
            // Guardar solo los mejores 10
            const top10 = records.slice(0, 10);
            localStorage.setItem('invisiblePathRecords', JSON.stringify(top10));
            displayRecords();
        }

        function displayRecords() {
            const records = loadRecords();
            const recordsList = document.getElementById('recordsList');
            
            if (records.length === 0) {
                recordsList.innerHTML = '<div class="no-records">No hay récords aún. ¡Sé el primero!</div>';
                return;
            }

            recordsList.innerHTML = records.map((record, index) => {
                let medal = '';
                if (index === 0) medal = '🥇';
                else if (index === 1) medal = '🥈';
                else if (index === 2) medal = '🥉';
                
                return `
                    <div class="record-item">
                        <span class="record-rank">${medal} #${index + 1}</span>
                        <span class="record-level">Nivel ${record.level}</span>
                        <span class="record-time">${record.time}s</span>
                        <span style="color: #666; font-size: 12px;">${record.date}</span>
                    </div>
                `;
            }).join('');
        }

        function clearRecords() {
            if (confirm('¿Estás seguro de que quieres borrar todos los récords?')) {
                localStorage.removeItem('invisiblePathRecords');
                displayRecords();
            }
        }

        // Mostrar récords al cargar la página
        displayRecords();

        function generateLevel() {
            // RESET TOTAL DEL NIVEL
            path = [];
            showPath = true;

            // POSICIÓN INICIAL
            player.x = 4;
            player.y = 8;

            let x = player.x;
            let y = player.y;

            path.push({ x, y });

            // GENERAR CAMINO CONTIGUO HASTA ARRIBA
            while (y > 0) {
                const r = Math.random();
                if (r < 0.4) {
                    x += Math.random() < 0.5 ? -1 : 1;
                    x = Math.max(0, Math.min(COLS - 1, x));
                } else {
                    y--;
                }
                path.push({ x, y });
            }

            // OBJETIVO AZUL
            goal.x = x;
            goal.y = y;

            // OCULTAR CAMINO DESPUÉS - Menos tiempo cada nivel
            // Nivel 1: 2000ms, Nivel 2: 1700ms, Nivel 3: 1400ms, etc.
            // Mínimo 500ms
            const displayTime = Math.max(500, 2000 - (level - 1) * 300);
            setTimeout(() => showPath = false, displayTime);
        }

        function drawGrid() {
            ctx.strokeStyle = "#222";
            for (let i = 0; i <= COLS; i++) {
                ctx.beginPath();
                ctx.moveTo(i * GRID, 0);
                ctx.lineTo(i * GRID, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i <= ROWS; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * GRID);
                ctx.lineTo(canvas.width, i * GRID);
                ctx.stroke();
            }
        }

        function drawPath() {
            if (!showPath) return;
            ctx.fillStyle = "#0f0";
            path.forEach(p =>
                ctx.fillRect(p.x * GRID, p.y * GRID, GRID, GRID)
            );
        }

        function drawGoal() {
            ctx.fillStyle = "blue";
            ctx.fillRect(goal.x * GRID, goal.y * GRID, GRID, GRID);
        }

        function isOnPath() {
            return path.some(p => p.x === player.x && p.y === player.y);
        }

        function update() {
            if (!running) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawGrid();
            drawGoal();
            drawPath();

            // JUGADOR
            ctx.fillStyle = "cyan";
            ctx.fillRect(
                player.x * GRID + 12,
                player.y * GRID + 12,
                player.size,
                player.size
            );

            // MUERTE
            if (!isOnPath()) {
                gameOver();
                return;
            }

            // NUEVO NIVEL AL LLEGAR AL AZUL
            if (player.x === goal.x && player.y === goal.y) {
                level++;
                document.getElementById("level").textContent = level;
                generateLevel();
            }

            requestAnimationFrame(update);
        }

        function startGame() {
            running = true;
            time = 0;
            level = 1;

            document.getElementById("level").textContent = level;

            generateLevel();

            clearInterval(timeLoop);
            timeLoop = setInterval(() => {
                time++;
                document.getElementById("time").textContent = time;
            }, 1000);

            update();
        }

        function gameOver() {
            running = false;
            clearInterval(timeLoop);
            saveRecord(level, time);
            alert("GAME OVER\nNivel alcanzado: " + level + "\nTiempo: " + time + " s");
        }

        let timeLoop;

        document.addEventListener("keydown", e => {
            if (!running) return;

            if (e.key === "w" || e.key === "ArrowUp") player.y--;
            if (e.key === "s" || e.key === "ArrowDown") player.y++;
            if (e.key === "a" || e.key === "ArrowLeft") player.x--;
            if (e.key === "d" || e.key === "ArrowRight") player.x++;

            player.x = Math.max(0, Math.min(COLS - 1, player.x));
            player.y = Math.max(0, Math.min(ROWS - 1, player.y));
        });
    </script>

</body>
</html>
